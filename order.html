<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>Kaffees - Order</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="./assets/images/favicon.ico" type="image/vnd.microsoft.icon">
    <link rel="icon" href="./assets/images/favicon.ico" type="image/vnd.microsoft.icon">
    <script src="./assets/js/vue.js"></script>
    <script src="./assets/js/axios.min.js"></script>
    <script src="./assets/js/random.js"></script>
    <script type="text/javascript" src="./assets/js/config.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="./assets/bootstrap/css/bootstrap.min.css">
    <script src="./assets/js/jquery-3.3.1.min.js"></script>
    <script src="./assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
    <link rel="stylesheet" href="./assets/stylesheets/base.css">
  </head>
  <body>
    <div id="app">
      <v-loading :show="loadingIcon"></v-loading>

      <div class="order" v-show="orderWindow">
        <h1>注文</h1>
        <div class="form-group row" v-for="product in products" v-if="productsSwitch(product)">
          <label for="inputCaffeeBlend" class="col-sm-4 col-form-label"> {{ product.name }} ({{ product.price }}円) </label>
          <div class="col-sm-8">
            <select class="form-control" id="input" v-model.number="product.piece">
              <option selected>0</option>
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
            </select>
          </div> <!-- col-sm-8 -->
        </div> <!-- form-group row -->

        <div class="form-group row">
          <label for="inputTime" class="col-sm-4 col-form-label">受け取りの時間を指定する</label>
          <div class="col-sm-5">
            <input type="text" class="timepicker form-control" v-model="wait_time">
          </div>
          <div class="col-sm-3">に受け取り</div>
        </div> <!-- form-group row -->

        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#confirmationModal" v-bind:disabled="confirmationSubmitDisabled" v-on:click="confirmationSubmit">
          確認画面にすすむ
        </button>
      </div> <!-- .order -->

      <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmationModalTitle">確認画面</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div> <!-- modal-header -->
            <div class="modal-body">
              <h4 class="text-danger">{{ msg }}</h4>
              <div v-if="!msg">
                <ul>
                  <li v-for="order in products" v-if="order.piece">
                    {{ order.name }}: {{order.piece}} 杯 ({{ order.price }})円
                  </li>
                </ul>
                <h5>
                  <span> 合計金額 {{ totalAmount }}円 </span> <br><br>
                  <span v-if="wait_time"> 受け取り指定時間 {{ wait_time }} </span> 
                  <span v-else> 5分以内の準備</span>
                </h5>
                <p>上記の内容で注文内容はよろしいですか？</p>
                <p class="blockquote-footer">注文を確定すると<a href="agreement.html" target="_blank" >利用規約</a>を同意したこととなります</p>
              </div> <!-- v-if='!msg' -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">注文を修正</button>
                <button type="button" class="btn btn-primary" v-on:click="submit" data-dismiss="modal" v-bind:disabled="orderSubmitDisabled" >
                  注文を確定
                </button>
              </div> <!-- div.modal-footer -->
            </div> <!-- div.modal-body -->
          </div> <!-- div.modal-content -->
        </div> <!-- div.modal-dialog -->
      </div> <!-- div.modal.fade -->

      <div class="determination" v-show="determinationWindow">
        <h2>注文が確定いたしました</h2>
        <ol>
          <ul v-for="order in orderedData.products">
            {{ order.name }}
          </ul>
        </ol>
        <p v-if="orderedData.order.wait_time">受け取り時間 {{ new Date(orderedData.order.wait_time).toLocaleTimeString() }}</p>
        <p v-else> 受け取り時間指定なし</p>
        <p>伝票番号 {{ orderedData.counter.receipt_number }} 番になります</p>
      </div> <!-- .determination -->

      <a href="index.html">戻る</a>
    </div> <!-- #app -->
  </body>

  <style>
   
  </style>

  <script type="text/javascript">
  var ws;
  let config = new CONFIG();
  let random = new Random();
  let clientId = random.create();

  Vue.component('v-loading', {
    props: {
      show: {
        default: false,
        type: Boolean
      }
    },
    template: '<transition name="fade"><div v-if="show" id="loader-bg"><img src="./assets/images/loading2.gif"></div></transition>'
  });

  var vm = new Vue({
    el: '#app',
    data: {
      orderWindow: true,
      determinationWindow: false,
      confirmationSubmitDisabled: true,
      orderSubmitDisabled: false,
      loadingIcon: true,
      orderedData: {
        order: {},
        counter: {},
        products: {},
      },
      products: {},
      wait_time: "",
      nowTime: "10:00:00",
      totalAmount: 0,
      msg: "",
    },
    methods: {
      confirmationSubmit() {
        vm.totalAmount = 0;

        let num = 0;
        for (key in vm.products) {
          let orders = vm.products[key];
          num += orders.piece;
          if ( orders.piece ) {
            vm.totalAmount += orders.price * orders.piece;
          }
        }

        vm.wait_time = $("input.timepicker").val();

        if(0 < num && num <= 4){
          vm.orderSubmitDisabled = false;
          vm.msg = "";
        } else if(num == 0) {
          vm.msg = '注文を入力してください';
          vm.orderSubmitDisabled = true;
        } else {
          vm.msg = '注文は一回に４杯まででおねがいします'
            vm.orderSubmitDisabled = true;
        }
      },
      submit() { // 注文確定ボタン
        data = JSON.stringify({
          clientId: clientId,
          products: vm.products,
          wait_time: vm.wait_time,
          });
        ws.send(data);
        
      },
      productsSwitch(product) {
        if ( !(localStorage.userToken) ) {
          return !(product.staff_only)
        }
        return true
      }
    },
    mounted: () => {
      // get Products(Menu)
      let url = config.url(location.protocol) + '/products';
      axios.get(url).then( response => {
        vm.products = response.data;
        vm.loadingIcon = false;
      }).catch( err => {
        console.log(err);
      }).then( () => {
        // always executed
      });

      new Promise( (resolve, reject) => {
        let url = config.wsurl(location.protocol) + '/orders/create';
        ws = new WebSocket(url);
        resolve();
      }).then( () =>  {

        ws.onopen = () => {
          vm.confirmationSubmitDisabled = false;
          if ( localStorage.orderData ) { //注文履歴の存在
            vm.orderedData = JSON.parse(localStorage.orderData);
            vm.orderWindow = false; // 注文画面非表示
            vm.determinationWindow = true; // 注文確定画面表示
          }
        }

        ws.onclose = () => {
          vm.confirmationSubmitDisabled = true; //注文ボタン無効化
          alert("サーバーとの接続が切断されました。ブラウザを再更新します");
        }

        ws.onmessage = evt => {
          let data = JSON.parse(evt.data);
          if ( data.client_id === clientId ) { //この端末で注文されたデータか確認
            if ( localStorage.userToken ) { //ゲストの場合注文完了画面に移動
              alert("受け取り番号: " + data.counter.receipt_number + "番をお客様に渡してください")
              location.reload();
            } else {
              localStorage.setItem('orderData', evt.data);
              location.reload()
            }
          }
        }

      });

      setInterval( () => { // heroku 対策
        ws.send(JSON.stringify({text: "dumy"}))
        console.log("send")
      }, 15000);
    }
  })

  $(document).ready(function(){
    var today = new Date();
    $('input.timepicker').timepicker({
      timeFormat: 'H:mm',
      interval: 5,
      minTime: '9',
      maxTime: '03:00pm',
      defaultTime: today.getHours() + ':' + today.getMinutes(),
      startTime: '09:00',
      dynamic: false,
      dropdown: true,
      scrollbar: true
    });
  });

  </script>
  </html>
